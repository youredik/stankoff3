# Руководство по BPMN процессам

Практическая инструкция для менеджеров по работе с бизнес-процессами в Stankoff Portal.

---

## 1. Что такое BPMN процесс

**BPMN** (Business Process Model and Notation) — стандарт описания бизнес-процессов в виде визуальных диаграмм.

Процесс в портале может:
- Автоматически менять статусы заявок
- Назначать исполнителей
- Отправлять уведомления и email
- Создавать задачи для ручной обработки (User Tasks)
- Классифицировать заявки с помощью AI
- Эскалировать при нарушении SLA

### Основные элементы BPMN

| Элемент | Обозначение | Описание |
|---------|-------------|----------|
| **Start Event** | Круг | Начало процесса |
| **End Event** | Круг с толстой рамкой | Конец процесса |
| **Service Task** | Прямоугольник с шестерёнкой | Автоматическая задача (выполняется системой) |
| **User Task** | Прямоугольник с человечком | Ручная задача (появляется в Inbox) |
| **Exclusive Gateway** | Ромб с X | Разветвление «или/или» (только один путь) |
| **Parallel Gateway** | Ромб с + | Разветвление «и» (все пути одновременно) |
| **Sequence Flow** | Стрелка | Переход между элементами |

---

## 2. Быстрый старт: использование шаблона

Самый простой способ начать — использовать готовый шаблон.

### Шаг 1: Откройте настройки процессов

1. Перейдите в ваш workspace
2. Откройте **Настройки** → **Процессы**
3. Нажмите **Создать процесс**

### Шаг 2: Выберите шаблон

Портал содержит **13 готовых шаблонов** по категориям:

| Категория | Шаблоны |
|-----------|---------|
| **Согласование** | Простое согласование, Многоуровневое согласование |
| **Техподдержка** | Обработка заявки, Техподдержка (полный цикл), Управление рекламациями, Автоэскалация по SLA |
| **HR** | Заявка на отпуск, Онбординг сотрудника |
| **Финансы** | Согласование расходов, Заказ на закупку |
| **IT** | Запрос на изменение, Управление инцидентами |
| **Операции** | Рецензирование документа |

### Шаг 3: Настройте триггер

Процесс можно запускать автоматически при определённых событиях:

- **При создании заявки** (`on_create`) — процесс запустится при каждой новой заявке
- **При смене статуса** (`on_status_change`) — при переходе в определённый статус
- **При назначении** (`on_assign`) — при назначении исполнителя
- **Вебхук** (`webhook`) — при вызове внешним сервисом
- **По расписанию** (`scheduled`) — по cron-расписанию

### Шаг 4: Разверните процесс

Нажмите **Развернуть** — процесс будет отправлен в Zeebe (движок выполнения). После развёртывания он начнёт обрабатывать заявки автоматически.

---

## 3. Создание своего процесса

### Визуальный редактор

Портал содержит встроенный **BPMN-редактор** на базе bpmn-js. Для создания процесса:

1. Нажмите **Создать процесс** → **Пустой процесс**
2. В редакторе перетаскивайте элементы из палитры слева
3. Соединяйте элементы стрелками (Sequence Flow)
4. Настраивайте свойства элементов в панели справа

### Доступные автоматические задачи (Service Tasks)

При создании Service Task укажите один из типов задач (**Task Type**):

| Task Type | Описание | Обязательные переменные |
|-----------|----------|-------------------------|
| `update-entity-status` | Сменить статус заявки | `entityId`, `newStatus` |
| `send-notification` | Отправить уведомление в портале | `userId`, `message` |
| `send-email` | Отправить email | `to`, `subject`, `body` |
| `log-activity` | Записать в аудит-лог | `entityId`, `workspaceId`, `action` |
| `set-assignee` | Назначить/снять исполнителя | `entityId`, `assigneeId` |
| `classify-entity` | AI-классификация заявки | `entityId` |
| `process-completed` | Отметить процесс завершённым | (автоматически) |

### Пример: простой процесс обработки заявки

```
Start → Классификация (AI) → Назначение → Выполнение → Закрытие → End
```

1. **Start Event**: Процесс запускается при создании заявки
2. **Service Task** (classify-entity): AI классифицирует заявку
3. **Service Task** (set-assignee): Назначает исполнителя
4. **User Task**: Исполнитель выполняет задачу в Inbox
5. **Service Task** (update-entity-status): Меняет статус на «Закрыта»
6. **End Event**: Процесс завершён

### Переменные процесса

При запуске процесса автоматически доступны переменные:

| Переменная | Описание |
|------------|----------|
| `entityId` | ID заявки, для которой запущен процесс |
| `workspaceId` | ID workspace |
| `processInstanceKey` | Ключ экземпляра в Zeebe |

Дополнительные переменные можно задать при запуске или в Service Tasks.

---

## 4. Триггеры

Триггеры автоматически запускают процессы при определённых событиях.

### Создание триггера

1. Перейдите в **Настройки workspace** → **Триггеры**
2. Нажмите **Создать триггер**
3. Выберите:
   - **Процесс** — какой процесс запустить
   - **Событие** — при каком событии запускать
   - **Условия** (опционально) — дополнительные фильтры

### Типы триггеров

**on_create** — при создании заявки:
- Хорошо для: стандартной обработки всех новых заявок, AI-классификации

**on_status_change** — при смене статуса:
- Можно указать конкретный статус
- Хорошо для: эскалации, уведомлений при закрытии

**on_assign** — при назначении исполнителя:
- Хорошо для: уведомления назначенному

**webhook** — внешний вызов:
- URL: `POST /api/bpmn/webhooks/:workspaceId/:triggerId`
- Хорошо для: интеграции с внешними системами

**scheduled** — по расписанию (cron):
- Хорошо для: периодических проверок SLA, отчётов

---

## 5. User Tasks (задачи в Inbox)

**User Task** — это шаг процесса, требующий ручного действия от пользователя.

### Как работать с Inbox

1. В боковом меню нажмите **Inbox** (значок входящих)
2. Вы увидите список назначенных вам задач
3. Нажмите на задачу для просмотра деталей
4. Заполните форму (если есть) и нажмите **Завершить**

### Действия с задачами

| Действие | Описание |
|----------|----------|
| **Взять** (Claim) | Назначить задачу себе |
| **Отпустить** (Unclaim) | Вернуть задачу в общий пул |
| **Завершить** (Complete) | Выполнить задачу с результатом |
| **Делегировать** (Delegate) | Передать другому пользователю |

### Формы задач

User Tasks могут содержать формы для ввода данных. Типы форм:
- **Approval** — одобрение/отклонение (кнопки «Одобрить» / «Отклонить»)
- **Review** — рецензирование с комментарием
- **Data Entry** — ввод данных (произвольные поля)
- **Custom** — произвольная форма

---

## 6. Тепловая карта (Heat Map)

Тепловая карта показывает статистику выполнения каждого элемента процесса.

### Как открыть

1. Перейдите в **Настройки** → **Процессы**
2. Нажмите на развёрнутый процесс (со значком версии)
3. Откроется страница с диаграммой и аналитикой

### Что показывает

- **Цвет элемента**: от зелёного (мало) до красного (много выполнений)
- **Бейдж с числом**: количество выполнений и среднее время
- **Красный фон бейджа**: процент ошибок > 10%

### Боковая панель

В правой части экрана отображаются:
- **Общая статистика**: количество экземпляров, завершённых, активных
- **Самые активные элементы**: топ-5 по количеству выполнений
- **Самые долгие элементы**: топ-5 по среднему времени выполнения
- **Информация о процессе**: Process ID, ключ, версия

---

## 7. Шаблоны для Сервисного отдела

Для отдела Сервиса подготовлены 3 специализированных шаблона:

### 7.1. Техподдержка (полный цикл) — `service-support-v2`

ITIL-совместимый процесс обработки обращений:

1. **AI-классификация**: автоматическое определение категории и приоритета
2. **Маршрутизация L1/L2**: простые вопросы — L1, сложные — L2
3. **User Task**: специалист обрабатывает обращение
4. **Эскалация**: если L1 не справился — передача на L2
5. **Ожидание клиента**: если нужна информация от клиента
6. **Автозакрытие**: если клиент не ответил
7. **Переквалификация**: при необходимости — в рекламацию

**Время**: 15 мин — 72 часа

### 7.2. Управление рекламациями — `claims-management`

Процесс по ISO 10002:

1. **Регистрация** рекламации (смена статуса, уведомления)
2. **Расследование**: назначение ответственного, сбор данных
3. **RCA** (Root Cause Analysis): анализ корневых причин
4. **Решение**: User Task для принятия решения
5. **Корректирующие действия**: при необходимости
6. **Уведомление клиента**: о результатах

**Время**: 1—14 дней

### 7.3. Автоэскалация по SLA — `sla-escalation`

Автоматическая эскалация при нарушении SLA:

- **80% от срока**: предупреждение исполнителю
- **100% от срока**: нарушение SLA, уведомление руководителя
- **150% от срока**: критическое нарушение, эскалация на директора

**Время**: 1—5 минут (запускается по таймеру)

---

## 8. FAQ

### Что произойдёт, если процесс упадёт?
Zeebe автоматически повторяет упавшие задачи. Если задача падает 3 раза — она переходит в статус **Incident** (инцидент). Вы увидите это в статистике процесса.

### Можно ли остановить запущенный процесс?
Да, на странице экземпляра процесса есть кнопка **Отменить** (Terminate). Процесс прекратит выполнение, статус станет «Terminated».

### Как изменить уже развёрнутый процесс?
Отредактируйте процесс в редакторе и нажмите **Развернуть** снова. Будет создана новая версия. Существующие экземпляры продолжат работу по старой версии, а новые запустятся по новой.

### Как посмотреть, какие процессы выполняются?
Перейдите в **Настройки** → **Процессы** → выберите процесс. На странице видна статистика: сколько активных, завершённых и упавших экземпляров.

### Процесс не запускается при создании заявки
Проверьте:
1. Процесс **развёрнут** (есть номер версии, зелёный бейдж)
2. Триггер **создан и активен**
3. Тип триггера = `on_create`

### User Task не появляется в Inbox
Проверьте:
1. В BPMN задача имеет тип **User Task** (не Service Task)
2. У задачи указан **assignee** или **candidateGroups**
3. Вы входите в указанную группу
