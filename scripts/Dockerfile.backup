# Backup Cron Service
FROM alpine:3.19

# Install dependencies (no dcron â€” use BusyBox built-in crond for Docker compatibility)
RUN apk add --no-cache \
    bash \
    postgresql16-client \
    aws-cli \
    curl \
    tzdata

# Set timezone
ENV TZ=Europe/Moscow
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Create backup directory
RUN mkdir -p /backups /scripts

# Copy backup script
COPY backup.sh /scripts/backup.sh
RUN chmod +x /scripts/backup.sh

# Create cron job (twice a day: 03:00 and 15:00 Moscow time)
RUN echo "0 3,15 * * * /scripts/backup.sh scheduled >> /var/log/backup.log 2>&1" > /etc/crontabs/root

# Create log file
RUN touch /var/log/backup.log

# Healthcheck
HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=3 \
    CMD pgrep crond || exit 1

# Start BusyBox crond in foreground
CMD ["crond", "-f", "-l", "2"]
